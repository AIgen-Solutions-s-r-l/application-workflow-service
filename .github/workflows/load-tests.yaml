name: Load Tests

on:
  # Manual trigger with parameters
  workflow_dispatch:
    inputs:
      users:
        description: 'Number of concurrent users'
        required: true
        default: '50'
        type: string
      spawn_rate:
        description: 'Users spawned per second'
        required: true
        default: '5'
        type: string
      duration:
        description: 'Test duration (e.g., 5m, 10m)'
        required: true
        default: '5m'
        type: string
      scenario:
        description: 'Test scenario'
        required: true
        default: 'standard'
        type: choice
        options:
          - standard
          - spike
          - soak
          - stress

  # Scheduled runs - weekly on Sunday at 2 AM UTC
  schedule:
    - cron: '0 2 * * 0'

  # Optional: Run on release tags
  # push:
  #   tags:
  #     - 'v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  load-test:
    name: Run Load Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      rabbitmq:
        image: rabbitmq:3.12-management
        ports:
          - 5672:5672
          - 15672:15672
        env:
          RABBITMQ_DEFAULT_USER: guest
          RABBITMQ_DEFAULT_PASS: guest
        options: >-
          --health-cmd "rabbitmq-diagnostics -q ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: 1.7.1
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        run: poetry install --no-interaction --no-root

      - name: Install project
        run: poetry install --no-interaction

      - name: Install load test dependencies
        run: |
          poetry run pip install locust python-jose

      - name: Start Application
        env:
          SERVICE_NAME: application_manager_service
          MONGODB: mongodb://localhost:27017
          MONGODB_DATABASE: resumes_loadtest
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: loadtest-secret-key-for-testing
          ALGORITHM: HS256
          DEBUG: "false"
          ENVIRONMENT: loadtest
          ASYNC_PROCESSING_ENABLED: "true"
          RATE_LIMIT_ENABLED: "false"
          MIGRATIONS_AUTO_RUN: "true"
          LOG_LEVEL: WARNING
        run: |
          poetry run uvicorn app.main:app --host 0.0.0.0 --port 8009 &
          echo "Waiting for application to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8009/health/live > /dev/null; then
              echo "Application is ready!"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

      - name: Start Worker
        env:
          SERVICE_NAME: application_worker
          MONGODB: mongodb://localhost:27017
          MONGODB_DATABASE: resumes_loadtest
          RABBITMQ_URL: amqp://guest:guest@localhost:5672/
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: loadtest-secret-key-for-testing
          ALGORITHM: HS256
          DEBUG: "false"
          ENVIRONMENT: loadtest
          LOG_LEVEL: WARNING
        run: |
          poetry run python -m app.workers.application_worker &
          sleep 5

      - name: Verify services are ready
        run: |
          curl -f http://localhost:8009/health || exit 1
          echo "All services are healthy"

      - name: Set test parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "users=${{ github.event.inputs.users }}" >> $GITHUB_OUTPUT
            echo "spawn_rate=${{ github.event.inputs.spawn_rate }}" >> $GITHUB_OUTPUT
            echo "duration=${{ github.event.inputs.duration }}" >> $GITHUB_OUTPUT
            echo "scenario=${{ github.event.inputs.scenario }}" >> $GITHUB_OUTPUT
          else
            # Default parameters for scheduled runs
            echo "users=50" >> $GITHUB_OUTPUT
            echo "spawn_rate=5" >> $GITHUB_OUTPUT
            echo "duration=5m" >> $GITHUB_OUTPUT
            echo "scenario=standard" >> $GITHUB_OUTPUT
          fi

      - name: Run Load Tests
        run: |
          cd load_tests
          poetry run locust \
            -f locustfile.py \
            --headless \
            --host http://localhost:8009 \
            -u ${{ steps.params.outputs.users }} \
            -r ${{ steps.params.outputs.spawn_rate }} \
            -t ${{ steps.params.outputs.duration }} \
            --html report.html \
            --csv results \
            --only-summary
        continue-on-error: true

      - name: Check thresholds
        id: thresholds
        run: |
          cd load_tests
          poetry run python check_thresholds.py \
            --csv-prefix results \
            --scenario ${{ steps.params.outputs.scenario }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: load-test-results-${{ github.run_number }}
          path: |
            load_tests/report.html
            load_tests/results_*.csv
            load_tests/threshold_report.json
          retention-days: 30

      - name: Post results to PR (if applicable)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let report = '## ðŸ“Š Load Test Results\n\n';

            try {
              const stats = fs.readFileSync('load_tests/results_stats.csv', 'utf8');
              const lines = stats.trim().split('\n');
              const headers = lines[0].split(',');

              report += '| Endpoint | Requests | Failures | Avg (ms) | P95 (ms) | P99 (ms) |\n';
              report += '|----------|----------|----------|----------|----------|----------|\n';

              for (let i = 1; i < Math.min(lines.length, 10); i++) {
                const values = lines[i].split(',');
                report += `| ${values[1]} | ${values[2]} | ${values[3]} | ${values[5]} | ${values[9]} | ${values[10]} |\n`;
              }
            } catch (e) {
              report += 'âš ï¸ Could not parse results CSV\n';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if thresholds exceeded
        if: steps.thresholds.outcome == 'failure'
        run: |
          echo "::error::Load test thresholds exceeded!"
          exit 1

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: load-test
    if: failure() && github.event_name == 'schedule'
    steps:
      - name: Create issue on failure
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Scheduled Load Test Failed - ${date}`,
              body: `The scheduled load test failed on ${date}.\n\nPlease investigate the [workflow run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}).`,
              labels: ['load-test', 'automated', 'needs-investigation']
            });
